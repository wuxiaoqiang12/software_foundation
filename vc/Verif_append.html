<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href="common/css/sf.css" rel="stylesheet" type="text/css"/>
<title>Verif_append: List segments, magic wand</title>
</head>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/vc.css" rel="stylesheet" type="text/css"/>

<body>

<div id="page">

<div id="header">
<a href='https://www.cis.upenn.edu/~bcpierce/sf/current/index.html'>
<img src='common/media/image/sf_logo_sm.png'></a>
</br><a href='index.html'>  <span class='booktitleinheader'>Volume 5beta: Verifiable C</span><br></br>
<ul id='menu'>
   <a href='toc.html'><li class='section_name'>Table of Contents</li></a>
   <a href='coqindex.html'><li class='section_name'>Index</li></a>
</ul>
</a></div>

<div id="main">

<h1 class="libtitle">Verif_append<span class="subtitle">List segments, magic wand</span></h1>


<div class="doc">

<div class="paragraph"> </div>

 THIS CHAPTER IS JUST A STUB RIGHT NOW. 
<div class="paragraph"> </div>

 This chapter should show how to prove the correctness
 of adding up a list, two different ways:

<div class="paragraph"> </div>

<ul class="doclist">
<li> with list-segments

</li>
<li> with magic wand

</li>
</ul>
 Then it should show proofs of the <span class="inlinecode"><span class="id" type="var">append</span></span> function,
 two different ways:

<div class="paragraph"> </div>

<ul class="doclist">
<li> with list-segments

</li>
<li> with magic wand

</li>
</ul>

<div class="paragraph"> </div>

<a name="lab62"></a><h2 class="section">Here is a little C program, <span class="inlinecode"><span class="id" type="var">reverse.c</span></span></h2>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<pre>
#include &lt;stddef.h&gt;

struct list {int head; struct list *tail;};

unsigned sumlist (struct list *p) {
  unsigned s = 0;
  struct list *t = p;
  unsigned h;
  while (t) {
     h = t-&gt;head;
     t = t-&gt;tail;
     s = s + h;
  }
  return s;
}

struct list *append (struct list *x, struct list *y) {
  struct list *t, *u;
  if (x==NULL)
    return y;
  else {
    t = x;
    u = t-&gt;tail;
    while (u!=NULL) {
      t = u;
      u = t-&gt;tail;
    }
    t-&gt;tail = y;
    return x;
  }
}
</pre>

</div>
<div class="code code-tight">

<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="library">VST.floyd.proofauto</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="library">append</span>.<br/>
<span class="id" type="keyword">Instance</span> <a name="CompSpecs"><span class="id" type="instance">CompSpecs</span></a> : <span class="id" type="class">compspecs</span>. <span class="id" type="var">make_compspecs</span> <span class="id" type="definition">prog</span>. <span class="id" type="keyword">Defined</span>.<br/>
<span class="id" type="keyword">Definition</span> <a name="Vprog"><span class="id" type="definition">Vprog</span></a> : <span class="id" type="definition">varspecs</span>. <span class="id" type="var">mk_varspecs</span> <span class="id" type="definition">prog</span>. <span class="id" type="keyword">Defined</span>.<br/>
</div>

<div class="doc">
<a name="lab63"></a><h2 class="section">Inductive definition of linked lists</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Definition</span> <a name="t_list"><span class="id" type="definition">t_list</span></a> := <span class="id" type="constructor">Tstruct</span> <span class="id" type="definition">_list</span> <span class="id" type="definition">noattr</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Fixpoint</span> <a name="listrep"><span class="id" type="definition">listrep</span></a> (<span class="id" type="var">sigma</span>: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="inductive">val</span>) (<span class="id" type="var">p</span>: <span class="id" type="inductive">val</span>) : <span class="id" type="definition">mpred</span> :=<br/>
&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="Verif_append.html#sigma"><span class="id" type="variable">sigma</span></a> <span class="id" type="keyword">with</span><br/>
&nbsp;| <span class="id" type="var">h</span>::<span class="id" type="var">hs</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">EX</span> <span class="id" type="var">y</span>:<span class="id" type="inductive">val</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="definition">data_at</span> <span class="id" type="definition">Tsh</span> <a class="idref" href="Verif_append.html#t_list"><span class="id" type="definition">t_list</span></a> (<span class="id" type="var">h</span>,<a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a>) <a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a>  *  <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="var">hs</span> <a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a><br/>
&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;!! (<a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a> = <span class="id" type="definition">nullval</span>) &amp;&amp; <span class="id" type="method">emp</span><br/>
&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="var">Arguments</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span> : <span class="id" type="tactic">simpl</span> <span class="id" type="var">never</span>.<br/>
</div>

<div class="doc">
<a name="lab64"></a><h2 class="section">Hint databases for spatial operators</h2>

<div class="paragraph"> </div>

 This is the same proof as in <a href="Verif_reverse.html"><span class="inlineref">Verif_reverse</span></a> 
</div>
<div class="code code-tight">
<span class="id" type="keyword">Lemma</span> <a name="listrep_local_facts"><span class="id" type="lemma">listrep_local_facts</span></a>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <a class="idref" href="Verif_append.html#sigma"><span class="id" type="variable">sigma</span></a> <a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a> |--<br/>
&nbsp;&nbsp;&nbsp;!! (<span class="id" type="definition">is_pointer_or_null</span> <a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a> ∧ (<a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a>=<span class="id" type="definition">nullval</span> ↔ <a class="idref" href="Verif_append.html#sigma"><span class="id" type="variable">sigma</span></a>=<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span>.<br/>
<span class="id" type="var">revert</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">induction</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">p</span>.<br/>
-<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>.<br/>
&nbsp;<span class="id" type="var">entailer</span>!.<br/>
&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">auto</span>.<br/>
-<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>; <span class="id" type="var">fold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>.<br/>
&nbsp;<span class="id" type="var">entailer</span>.<br/>
&nbsp;<span class="id" type="var">entailer</span>!.<br/>
&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span>.<br/>
&nbsp;* <span class="id" type="tactic">clear</span> - <span class="id" type="var">H</span> <span class="id" type="var">H<sub>2</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">p</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="lemma">field_compatible_nullval</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;* <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>2</sub></span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="keyword">Resolve</span> <span class="id" type="var">listrep_local_facts</span> : <span class="id" type="var">saturate_local</span>.<br/>
</div>

<div class="doc">
This is the same proof as in <a href="Verif_reverse.html"><span class="inlineref">Verif_reverse</span></a> 
</div>
<div class="code code-tight">
<span class="id" type="keyword">Lemma</span> <a name="listrep_valid_pointer"><span class="id" type="lemma">listrep_valid_pointer</span></a>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <a class="idref" href="Verif_append.html#sigma"><span class="id" type="variable">sigma</span></a> <a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a> |-- <span class="id" type="definition">valid_pointer</span> <a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>.<br/>
&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">sigma</span>; <span class="id" type="tactic">simpl</span>.<br/>
* <span class="id" type="var">entailer</span>!.<br/>
* <span class="id" type="var">entailer</span>!.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">auto</span> <span class="id" type="keyword">with</span> <span class="id" type="var">valid_pointer</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="keyword">Resolve</span> <span class="id" type="var">listrep_valid_pointer</span> : <span class="id" type="var">valid_pointer</span>.<br/>
</div>

<div class="doc">
<a name="lab65"></a><h2 class="section">Specification of the <span class="inlinecode"><span class="id" type="var">sumlist</span></span> and <span class="inlinecode"><span class="id" type="var">append</span></span> functions.</h2>

</div>
<div class="code code-space">
<span class="id" type="keyword">Definition</span> <a name="sum_int"><span class="id" type="definition">sum_int</span></a> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="abbreviation">int</span> → <span class="id" type="abbreviation">int</span> := <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#fold_right"><span class="id" type="definition">fold_right</span></a> <span class="id" type="definition">Int.add</span> <span class="id" type="definition">Int.zero</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <a name="sumlist_spec"><span class="id" type="definition">sumlist_spec</span></a> : <span class="id" type="definition">ident</span> * <span class="id" type="inductive">funspec</span> :=<br/>
&nbsp;<span class="id" type="notation">DECLARE</span> <span class="id" type="definition">_sumlist</span><br/>
&nbsp;&nbsp;<span class="id" type="notation">WITH</span> <span class="id" type="var">sigma</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="abbreviation">int</span>, <span class="id" type="var">p</span>: <span class="id" type="inductive">val</span><br/>
&nbsp;&nbsp;<span class="id" type="var">PRE</span>  [ <span class="id" type="definition">_p</span> <span class="id" type="var">OF</span> (<span class="id" type="definition">tptr</span> <a class="idref" href="Verif_append.html#t_list"><span class="id" type="definition">t_list</span></a>) ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">PROP</span> ()<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">LOCAL</span> (<span class="id" type="constructor">temp</span> <span class="id" type="definition">_p</span> <a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">SEP</span> (<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <span class="id" type="constructor">Vint</span> <a class="idref" href="Verif_append.html#sigma"><span class="id" type="variable">sigma</span></a>) <a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="var">POST</span> [ (<span class="id" type="definition">tptr</span> <a class="idref" href="Verif_append.html#t_list"><span class="id" type="definition">t_list</span></a>) ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">PROP</span> () <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">LOCAL</span> (<span class="id" type="constructor">temp</span> <span class="id" type="definition">ret_temp</span> (<span class="id" type="constructor">Vint</span> (<a class="idref" href="Verif_append.html#sum_int"><span class="id" type="definition">sum_int</span></a> <a class="idref" href="Verif_append.html#sigma"><span class="id" type="variable">sigma</span></a>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">SEP</span> (<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>(<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <span class="id" type="constructor">Vint</span> <a class="idref" href="Verif_append.html#sigma"><span class="id" type="variable">sigma</span></a>) <a class="idref" href="Verif_append.html#p"><span class="id" type="variable">p</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <a name="append_spec"><span class="id" type="definition">append_spec</span></a> :=<br/>
&nbsp;<span class="id" type="notation">DECLARE</span> <span class="id" type="definition">_append</span><br/>
&nbsp;&nbsp;<span class="id" type="notation">WITH</span> <span class="id" type="var">sh</span> : <span class="id" type="definition">share</span>, <span class="id" type="var">x</span>: <span class="id" type="inductive">val</span>, <span class="id" type="var">y</span>: <span class="id" type="inductive">val</span>, <span class="id" type="var">s<sub>1</sub></span>: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="inductive">val</span>, <span class="id" type="var">s<sub>2</sub></span>: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="inductive">val</span><br/>
&nbsp;&nbsp;<span class="id" type="var">PRE</span> [ <span class="id" type="definition">_x</span> <span class="id" type="var">OF</span> (<span class="id" type="definition">tptr</span> <a class="idref" href="Verif_append.html#t_list"><span class="id" type="definition">t_list</span></a>) , <span class="id" type="definition">_y</span> <span class="id" type="var">OF</span> (<span class="id" type="definition">tptr</span> <a class="idref" href="Verif_append.html#t_list"><span class="id" type="definition">t_list</span></a>)]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">PROP</span>(<span class="id" type="definition">writable_share</span> <a class="idref" href="Verif_append.html#sh"><span class="id" type="variable">sh</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">LOCAL</span> (<span class="id" type="constructor">temp</span> <span class="id" type="definition">_x</span> <a class="idref" href="Verif_append.html#x"><span class="id" type="variable">x</span></a>; <span class="id" type="constructor">temp</span> <span class="id" type="definition">_y</span> <a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">SEP</span> (<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <a class="idref" href="Verif_append.html#s<sub>1</sub>"><span class="id" type="variable">s<sub>1</sub></span></a> <a class="idref" href="Verif_append.html#x"><span class="id" type="variable">x</span></a>; <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <a class="idref" href="Verif_append.html#s<sub>2</sub>"><span class="id" type="variable">s<sub>2</sub></span></a> <a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="var">POST</span> [ <span class="id" type="definition">tptr</span> <a class="idref" href="Verif_append.html#t_list"><span class="id" type="definition">t_list</span></a> ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">EX</span> <span class="id" type="var">r</span>: <span class="id" type="inductive">val</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">PROP</span>()<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">LOCAL</span>(<span class="id" type="constructor">temp</span> <span class="id" type="definition">ret_temp</span> <a class="idref" href="Verif_append.html#r"><span class="id" type="variable">r</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">SEP</span> (<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<a class="idref" href="Verif_append.html#s<sub>1</sub>"><span class="id" type="variable">s<sub>1</sub></span></a>++<a class="idref" href="Verif_append.html#s<sub>2</sub>"><span class="id" type="variable">s<sub>2</sub></span></a>) <a class="idref" href="Verif_append.html#r"><span class="id" type="variable">r</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <a name="Gprog"><span class="id" type="definition">Gprog</span></a> : <span class="id" type="definition">funspecs</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ltac</span>:(<span class="id" type="var">with_library</span> <span class="id" type="definition">prog</span> [ <a class="idref" href="Verif_append.html#sumlist_spec"><span class="id" type="definition">sumlist_spec</span></a>; <a class="idref" href="Verif_append.html#append_spec"><span class="id" type="definition">append_spec</span></a> ]).<br/>
</div>

<div class="doc">
In separation-logic assertions, how should one specify integer values?
    Normally, one should use the mathematical integers, Coq's <span class="inlinecode"><span class="id" type="var">Z</span></span> type.
    Then, inject <span class="inlinecode"><span class="id" type="var">Z</span></span> into the 32-bit machine integers using Int.repr,
    then from those into CompCert values by Vint.  That is,
    <span class="inlinecode"><span class="id" type="var">Vint</span></span> <span class="inlinecode">(<span class="id" type="var">Int.repr</span></span> <span class="inlinecode"><span class="id" type="var">z</span>)</span>, where <span class="inlinecode"><span class="id" type="var">z</span>:<span class="id" type="var">Z</span></span> is a mathematical integer.

<div class="paragraph"> </div>

    If <span class="inlinecode"><span class="id" type="var">z</span></span> is too big to fit in a 32-bit integer, <span class="inlinecode"><span class="id" type="var">Int.repr</span></span> will take
    the low-order 32 bits (i.e., modulo 2^32).  To make sure that doesn't
    happen (if you didn't intend it), usually you maintain the assertion
    <span class="inlinecode"><span class="id" type="var">Int.min_signed</span></span> <span class="inlinecode">≤</span> <span class="inlinecode"><span class="id" type="var">z</span></span> <span class="inlinecode">≤</span> <span class="inlinecode"><span class="id" type="var">Int.max_signed</span></span>.  

<div class="paragraph"> </div>

    In this program, we are adding up a list of integers.  If we wanted
    to prove that every partial sum is in range, we'd need a complicated
    precondition.  Instead, we'll prove something simpler:  that the
    sum mod 2^32 is right.   

<div class="paragraph"> </div>

    In the C language, signed integer arithmetic is not allowed to
    overflow (you get undefined behavior), so we must write this program
    to use unsigned ints.  For that, we want to reason about
    32-bit machine integers directly, not about the mathematical integers.
    Therefore we'll use values of type <span class="inlinecode"><span class="id" type="var">int</span></span>, that is <span class="inlinecode"><span class="id" type="var">Int.int</span></span>, the
    type of 32-bit machine integers.  That's why, in <span class="inlinecode"><span class="id" type="var">sumlist_spec</span></span>,
    we use <span class="inlinecode"><span class="id" type="var">sigma</span>:</span> <span class="inlinecode"><span class="id" type="var">list</span></span> <span class="inlinecode"><span class="id" type="var">int</span></span> in our specification, instead of a list of <span class="inlinecode"><span class="id" type="var">Z</span></span>.

<div class="paragraph"> </div>

    Compare with the proof of <span class="inlinecode"><span class="id" type="var">pop_and_add</span></span> in <a href="Verif_triang.html"><span class="inlineref">Verif_triang</span></a>,
    where we <i>do</i> prove that each partial sum doesn't overflow, and
    we can use signed integer arithmetic. 
<div class="paragraph"> </div>

<a name="lab66"></a><h2 class="section">Proof of the <span class="inlinecode"><span class="id" type="var">sumlist</span></span> function</h2>

<div class="paragraph"> </div>

 First, we prove a useful auxiliary lemma about <span class="inlinecode"><span class="id" type="var">sum_int</span></span> 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Lemma</span> <a name="sum_int_app"><span class="id" type="lemma">sum_int_app</span></a>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">a</span> <span class="id" type="var">b</span>, <a class="idref" href="Verif_append.html#sum_int"><span class="id" type="definition">sum_int</span></a> (<a class="idref" href="Verif_append.html#a"><span class="id" type="variable">a</span></a>++<a class="idref" href="Verif_append.html#b"><span class="id" type="variable">b</span></a>) = <span class="id" type="definition">Int.add</span> (<a class="idref" href="Verif_append.html#sum_int"><span class="id" type="definition">sum_int</span></a> <a class="idref" href="Verif_append.html#a"><span class="id" type="variable">a</span></a>) (<a class="idref" href="Verif_append.html#sum_int"><span class="id" type="definition">sum_int</span></a> <a class="idref" href="Verif_append.html#b"><span class="id" type="variable">b</span></a>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="lemma">Int.add_zero_l</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHa</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="lemma">Int.add_assoc</span>. <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
TODO: This proof needs cleanup, and lots more explanation.  
</div>
<div class="code code-tight">
<span class="id" type="keyword">Lemma</span> <a name="body_sumlist"><span class="id" type="lemma">body_sumlist</span></a>: <span class="id" type="definition">semax_body</span> <a class="idref" href="Verif_append.html#Vprog"><span class="id" type="definition">Vprog</span></a> <a class="idref" href="Verif_append.html#Gprog"><span class="id" type="definition">Gprog</span></a> <span class="id" type="definition">f_sumlist</span> <a class="idref" href="Verif_append.html#sumlist_spec"><span class="id" type="definition">sumlist_spec</span></a>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
</div>

<div class="doc">
Here is the standard way to start a function-body proof:  
    First, <span class="inlinecode"><span class="id" type="var">start</span>-<span class="id" type="var">function</span></span>, then <span class="inlinecode"><span class="id" type="var">forward</span></span>. 
</div>
<div class="code code-tight">
<span class="id" type="var">start_function</span>.<br/>
<span class="id" type="var">forward</span>. <span class="comment">(*&nbsp;s&nbsp;=&nbsp;0;&nbsp;*)</span><br/>
<span class="id" type="var">forward</span>. <span class="comment">(*&nbsp;t&nbsp;=&nbsp;p;&nbsp;*)</span><br/>
<span class="id" type="var">forward_while</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="notation">EX</span> <span class="id" type="var">sigma2</span>: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="abbreviation">int</span>, <span class="id" type="notation">EX</span> <span class="id" type="var">t</span>: <span class="id" type="inductive">val</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">PROP</span> ()<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">LOCAL</span> (<span class="id" type="constructor">temp</span> <span class="id" type="definition">_t</span> <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="constructor">temp</span> <span class="id" type="definition">_s</span> (<span class="id" type="constructor">Vint</span> (<span class="id" type="definition">Int.sub</span> (<a class="idref" href="Verif_append.html#sum_int"><span class="id" type="definition">sum_int</span></a> <span class="id" type="var">sigma</span>) (<a class="idref" href="Verif_append.html#sum_int"><span class="id" type="definition">sum_int</span></a> <a class="idref" href="Verif_append.html#sigma2"><span class="id" type="variable">sigma2</span></a>))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">SEP</span> (<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <span class="id" type="constructor">Vint</span> <a class="idref" href="Verif_append.html#sigma2"><span class="id" type="variable">sigma2</span></a>) <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <span class="id" type="constructor">Vint</span> <a class="idref" href="Verif_append.html#sigma2"><span class="id" type="variable">sigma2</span></a>) <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a> -* <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <span class="id" type="constructor">Vint</span> <span class="id" type="var">sigma</span>) <span class="id" type="var">p</span>)).<br/>
- <span class="comment">(*&nbsp;Prove&nbsp;that&nbsp;current&nbsp;precondition&nbsp;implies&nbsp;loop&nbsp;invariant&nbsp;*)</span><br/>
<span class="id" type="var">Exists</span> <span class="id" type="var">sigma</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="var">entailer</span>!.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="method">wand_sepcon_adjoint</span>. <span class="id" type="var">cancel</span>.<br/>
- <span class="comment">(*&nbsp;Prove&nbsp;that&nbsp;loop&nbsp;invariant&nbsp;implies&nbsp;typechecking&nbsp;condition&nbsp;*)</span><br/>
<span class="id" type="var">entailer</span>!.<br/>
- <span class="comment">(*&nbsp;Prove&nbsp;that&nbsp;loop&nbsp;body&nbsp;preserves&nbsp;invariant&nbsp;*)</span><br/>
<span class="id" type="var">assert_PROP</span> (<span class="id" type="var">sigma2</span> ≠ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a>). {<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 1.<br/>
&nbsp;&nbsp;<span class="id" type="var">entailer</span>!.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">t</span>=<span class="id" type="definition">nullval</span>) <span class="id" type="tactic">by</span> <span class="id" type="tactic">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span>; <span class="id" type="var">contradiction</span>.<br/>
}<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">sigma2</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">i</span> <span class="id" type="var">r</span>]; <span class="id" type="tactic">try</span> <span class="id" type="var">contradiction</span>.<br/>
<span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">simpl</span> <span class="id" type="var">map</span>.<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 1; <span class="id" type="var">fold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>.<br/>
<span class="id" type="var">Intros</span> <span class="id" type="var">y</span>.<br/>
<span class="id" type="var">forward</span>.<br/>
<span class="id" type="var">forward</span>.<br/>
<span class="id" type="var">forward</span>.<br/>
<span class="id" type="var">Exists</span> (<span class="id" type="var">r</span>,<span class="id" type="var">y</span>).<br/>
<span class="id" type="var">entailer</span>!.<br/>
<span class="id" type="tactic">f_equal</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="lemma">Int.sub_add_l</span>.<br/>
<span class="id" type="tactic">rewrite</span> (<span class="id" type="lemma">Int.add_commut</span> <span class="id" type="var">i</span>).<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="lemma">Int.sub_shifted</span>. <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">apply</span> → <span class="id" type="method">wand_sepcon_adjoint</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="definition">data_at</span> <span class="id" type="definition">Tsh</span> <a class="idref" href="Verif_append.html#t_list"><span class="id" type="definition">t_list</span></a> (<span class="id" type="constructor">Vint</span> <span class="id" type="var">i</span>, <span class="id" type="var">y</span>) <span class="id" type="var">t</span> * <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <span class="id" type="constructor">Vint</span> <span class="id" type="var">r</span>) <span class="id" type="var">y</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|-- <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<span class="id" type="constructor">Vint</span> <span class="id" type="var">i</span> :: <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <span class="id" type="constructor">Vint</span> <span class="id" type="var">r</span>) <span class="id" type="var">t</span>).<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 2; <span class="id" type="var">fold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>.<br/>
<span class="id" type="var">Exists</span> <span class="id" type="var">y</span>; <span class="id" type="var">cancel</span>.<br/>
<span class="id" type="var">sep_apply</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H<sub>2</sub></span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="lemma">modus_ponens_wand</span>.<br/>
-<br/>
<span class="id" type="tactic">subst</span>.<br/>
<span class="id" type="var">forward</span>.<br/>
<span class="id" type="tactic">assert</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <span class="id" type="constructor">Vint</span> <span class="id" type="var">sigma2</span> = <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a>) <span class="id" type="tactic">by</span> <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">sigma2</span>; <span class="id" type="var">inv</span> <span class="id" type="var">H<sub>0</sub></span>.<br/>
<span class="id" type="tactic">eapply</span> <span class="id" type="method">derives_trans</span>. <span class="id" type="tactic">apply</span> <span class="id" type="lemma">modus_ponens_wand</span>.<br/>
<span class="id" type="var">entailer</span>!.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab67"></a><h2 class="section">Proof of the <span class="inlinecode"><span class="id" type="var">append</span></span> function</h2>

<div class="paragraph"> </div>

 TODO: This proof needs cleanup, and lots more explanation.  
</div>
<div class="code code-tight">
<span class="id" type="keyword">Definition</span> <a name="lseg"><span class="id" type="definition">lseg</span></a> (<span class="id" type="var">s</span>: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="inductive">val</span>) (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <span class="id" type="inductive">val</span>) := <br/>
&nbsp;&nbsp;<span class="id" type="notation">ALL</span> <span class="id" type="var">s'</span>: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="inductive">val</span>, <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <a class="idref" href="Verif_append.html#s'"><span class="id" type="variable">s'</span></a> <a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a> -* <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<a class="idref" href="Verif_append.html#s"><span class="id" type="variable">s</span></a> ++ <a class="idref" href="Verif_append.html#s'"><span class="id" type="variable">s'</span></a>) <a class="idref" href="Verif_append.html#x"><span class="id" type="variable">x</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Lemma</span> <a name="lseg_nullval"><span class="id" type="lemma">lseg_nullval</span></a>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span>, <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a> <a class="idref" href="Verif_append.html#s"><span class="id" type="variable">s</span></a> <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a> <span class="id" type="definition">nullval</span> = <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <a class="idref" href="Verif_append.html#s"><span class="id" type="variable">s</span></a> <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a>; <span class="id" type="tactic">intros</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="method">pred_ext</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="method">allp_left</span> <span class="id" type="keyword">with</span> (@<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a> <span class="id" type="inductive">val</span>).<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 1.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="lemma">prop_true_andp</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="lemma">emp_wand</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#app_nil_end"><span class="id" type="lemma">app_nil_end</span></a>.<br/>
<span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="method">allp_right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">s'</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="method">wand_sepcon_adjoint</span>.<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 2.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s'</span>; <span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#app_nil_end"><span class="id" type="lemma">app_nil_end</span></a>. <span class="id" type="var">entailer</span>!.<br/>
<span class="id" type="var">Intros</span> <span class="id" type="var">y</span>.<br/>
<span class="id" type="var">entailer</span>!.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>0</sub></span>; <span class="id" type="var">contradiction</span> <span class="id" type="var">H<sub>0</sub></span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Lemma</span> <a name="lseg_listrep"><span class="id" type="lemma">lseg_listrep</span></a>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a> <a class="idref" href="Verif_append.html#s"><span class="id" type="variable">s</span></a> <a class="idref" href="Verif_append.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a> * <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a> <a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a> |-- <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<a class="idref" href="Verif_append.html#s"><span class="id" type="variable">s</span></a>++<a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a>) <a class="idref" href="Verif_append.html#x"><span class="id" type="variable">x</span></a>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="tactic">intros</span>.<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a>.<br/>
<span class="id" type="var">allp_left</span> <span class="id" type="var">t</span>.<br/>
<span class="id" type="tactic">rewrite</span> <span class="id" type="method">sepcon_comm</span>.<br/>
<span class="id" type="tactic">apply</span> <span class="id" type="lemma">modus_ponens_wand</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Lemma</span> <a name="lseg_app"><span class="id" type="lemma">lseg_app</span></a>:<br/>
&nbsp;&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">s</span> <span class="id" type="var">t</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a> <a class="idref" href="Verif_append.html#s"><span class="id" type="variable">s</span></a> <a class="idref" href="Verif_append.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a> * <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a> <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a> <a class="idref" href="Verif_append.html#y"><span class="id" type="variable">y</span></a> <a class="idref" href="Verif_append.html#z"><span class="id" type="variable">z</span></a> |-- <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a> (<a class="idref" href="Verif_append.html#s"><span class="id" type="variable">s</span></a>++<a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a>) <a class="idref" href="Verif_append.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="Verif_append.html#z"><span class="id" type="variable">z</span></a>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="method">allp_right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">u</span>.<br/>
&nbsp;<span class="id" type="tactic">apply</span> → <span class="id" type="method">wand_sepcon_adjoint</span>.<br/>
&nbsp;<span class="id" type="var">sep_apply</span> (<a class="idref" href="Verif_append.html#lseg_listrep"><span class="id" type="lemma">lseg_listrep</span></a> <span class="id" type="var">t</span> <span class="id" type="var">u</span> <span class="id" type="var">y</span> <span class="id" type="var">z</span>).<br/>
&nbsp;<span class="id" type="var">sep_apply</span> (<a class="idref" href="Verif_append.html#lseg_listrep"><span class="id" type="lemma">lseg_listrep</span></a> <span class="id" type="var">s</span> (<span class="id" type="var">t</span>++<span class="id" type="var">u</span>) <span class="id" type="var">x</span> <span class="id" type="var">y</span>).<br/>
&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass"><span class="id" type="abbreviation">app_ass</span></a>.<br/>
&nbsp;<span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Lemma</span> <a name="body_append"><span class="id" type="lemma">body_append</span></a>: <span class="id" type="definition">semax_body</span> <a class="idref" href="Verif_append.html#Vprog"><span class="id" type="definition">Vprog</span></a> <a class="idref" href="Verif_append.html#Gprog"><span class="id" type="definition">Gprog</span></a> <span class="id" type="definition">f_append</span> <a class="idref" href="Verif_append.html#append_spec"><span class="id" type="definition">append_spec</span></a>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">start_function</span>.<br/>
<span class="id" type="var">forward_if</span>.<br/>
{ <span class="comment">(*&nbsp;then-clause&nbsp;*)</span><br/>
&nbsp;<span class="id" type="tactic">subst</span>.<br/>
&nbsp;<span class="id" type="var">forward</span>.<br/>
&nbsp;<span class="id" type="tactic">rewrite</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Logic.html#proj1"><span class="id" type="lemma">proj1</span></a> <span class="id" type="var">H</span>) <span class="id" type="tactic">by</span> <span class="id" type="tactic">auto</span>.<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 1. <span class="id" type="tactic">simpl</span> <span class="id" type="var">app</span>. <span class="id" type="var">Exists</span> <span class="id" type="var">y</span>. <span class="id" type="var">entailer</span>!.<br/>
}<br/>
<span class="comment">(*&nbsp;else-clause&nbsp;*)</span><br/>
<span class="id" type="var">assert_PROP</span> (<span class="id" type="var">s<sub>1</sub></span> ≠ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a>). {<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">entailer</span>!. <span class="id" type="tactic">intuition</span>.<br/>
&nbsp;&nbsp;}<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">s<sub>1</sub></span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">h</span> <span class="id" type="var">r</span>]; <span class="id" type="tactic">try</span> <span class="id" type="tactic">congruence</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span> <span class="id" type="var">H<sub>0</sub></span>.<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 1; <span class="id" type="var">fold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>.<br/>
<span class="id" type="var">Intros</span> <span class="id" type="var">u</span>.<br/>
<span class="id" type="var">forward</span>.<br/>
<span class="id" type="var">forward</span>.<br/>
<span class="id" type="var">forward_while</span> <br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="notation">EX</span> <span class="id" type="var">u</span>:<span class="id" type="inductive">val</span>, <span class="id" type="notation">EX</span> <span class="id" type="var">t</span>:<span class="id" type="inductive">val</span>, <span class="id" type="notation">EX</span> <span class="id" type="var">s'</span>: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="inductive">val</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">EX</span> <span class="id" type="var">i</span>: <span class="id" type="inductive">val</span>, <span class="id" type="notation">EX</span> <span class="id" type="var">r'</span>: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <span class="id" type="inductive">val</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">PROP</span> (<a class="idref" href="Verif_append.html#s'"><span class="id" type="variable">s'</span></a> ++ [<a class="idref" href="Verif_append.html#i"><span class="id" type="variable">i</span></a>] ++ <a class="idref" href="Verif_append.html#r'"><span class="id" type="variable">r'</span></a> = [<span class="id" type="var">h</span>] ++ <span class="id" type="var">r</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">LOCAL</span> (<span class="id" type="constructor">temp</span> <span class="id" type="definition">_u</span> <a class="idref" href="Verif_append.html#u"><span class="id" type="variable">u</span></a>; <span class="id" type="constructor">temp</span> <span class="id" type="definition">_t</span> <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a>; <span class="id" type="constructor">temp</span> <span class="id" type="definition">_x</span> <span class="id" type="var">x</span>; <span class="id" type="constructor">temp</span> <span class="id" type="definition">_y</span> <span class="id" type="var">y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="notation">SEP</span> (<a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a> <a class="idref" href="Verif_append.html#s'"><span class="id" type="variable">s'</span></a> <span class="id" type="var">x</span> <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a>; <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a> [<a class="idref" href="Verif_append.html#i"><span class="id" type="variable">i</span></a>] <a class="idref" href="Verif_append.html#t"><span class="id" type="variable">t</span></a> <a class="idref" href="Verif_append.html#u"><span class="id" type="variable">u</span></a>; <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <a class="idref" href="Verif_append.html#r'"><span class="id" type="variable">r'</span></a> <a class="idref" href="Verif_append.html#u"><span class="id" type="variable">u</span></a>; <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="var">s<sub>2</sub></span> <span class="id" type="var">y</span>)).<br/>
* <span class="comment">(*&nbsp;Prove&nbsp;that&nbsp;the&nbsp;precondition&nbsp;implies&nbsp;the&nbsp;loop&nbsp;invariant&nbsp;*)</span><br/>
&nbsp;<span class="id" type="var">Exists</span> <span class="id" type="var">u</span> <span class="id" type="var">x</span> (@<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a> <span class="id" type="inductive">val</span>) <span class="id" type="var">h</span> <span class="id" type="var">r</span>.<br/>
&nbsp;<span class="id" type="var">entailer</span>. <span class="comment">(*&nbsp;Cannot&nbsp;use&nbsp;entailer!&nbsp;here.&nbsp;*)</span><br/>
&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="method">sepcon_derives</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="method">derives_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="method">emp</span> * (<a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a> [<span class="id" type="var">h</span>] <span class="id" type="var">x</span> <span class="id" type="var">u</span> * <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="var">r</span> <span class="id" type="var">u</span>)).<br/>
&nbsp;<span class="id" type="var">cancel</span>.<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="method">allp_right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">s'</span>. <span class="id" type="tactic">apply</span> <span class="id" type="method">wand_sepcon_adjoint</span>.<br/>
&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 2; <span class="id" type="var">fold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>. <span class="id" type="var">Exists</span> <span class="id" type="var">u</span>; <span class="id" type="var">cancel</span>.<br/>
&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="method">sepcon_assoc</span>. <span class="id" type="tactic">apply</span> <span class="id" type="method">sepcon_derives</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="method">allp_right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">s'</span>. <span class="id" type="tactic">apply</span> <span class="id" type="method">wand_sepcon_adjoint</span>.<br/>
&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="var">cancel</span>.<br/>
* <span class="comment">(*&nbsp;Prove&nbsp;that&nbsp;the&nbsp;loop&nbsp;test&nbsp;can&nbsp;evaluate&nbsp;*)</span><br/>
&nbsp;<span class="id" type="var">entailer</span>!.<br/>
* <span class="comment">(*&nbsp;Prove&nbsp;the&nbsp;function&nbsp;body&nbsp;preserves&nbsp;the&nbsp;invariant&nbsp;*)</span><br/>
&nbsp;<span class="id" type="var">forward</span>.<br/>
&nbsp;<span class="id" type="var">assert_PROP</span> (<span class="id" type="var">r'</span> ≠ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a>) <span class="id" type="tactic">by</span> (<span class="id" type="var">entailer</span>!; <span class="id" type="tactic">intuition</span>).<br/>
&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">r'</span> <span class="id" type="keyword">as</span> [ | <span class="id" type="var">j</span> <span class="id" type="var">r'</span>]; <span class="id" type="tactic">try</span> <span class="id" type="tactic">congruence</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H<sub>0</sub></span>.<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 1; <span class="id" type="var">fold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>.<br/>
&nbsp;<span class="id" type="var">Intros</span> <span class="id" type="var">z</span>.<br/>
&nbsp;<span class="id" type="var">forward</span>.<br/>
&nbsp;<span class="id" type="var">Exists</span> (<span class="id" type="var">z</span>,<span class="id" type="var">u<sub>0</sub></span>,<span class="id" type="var">s'</span>++[<span class="id" type="var">i</span>],<span class="id" type="var">j</span>,<span class="id" type="var">r'</span>).<br/>
&nbsp;<span class="id" type="var">entailer</span>!.<br/>
&nbsp;<span class="id" type="tactic">rewrite</span> <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass"><span class="id" type="abbreviation">app_ass</span></a>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;<span class="id" type="var">sep_apply</span> (<a class="idref" href="Verif_append.html#lseg_app"><span class="id" type="lemma">lseg_app</span></a> <span class="id" type="var">s'</span> [<span class="id" type="var">i</span>] <span class="id" type="var">x</span> <span class="id" type="var">t</span> <span class="id" type="var">u<sub>0</sub></span>).<br/>
&nbsp;<span class="id" type="var">cancel</span>.<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a>. <span class="id" type="tactic">apply</span> <span class="id" type="method">allp_right</span>; <span class="id" type="tactic">intro</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="method">wand_sepcon_adjoint</span>.<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 2; <span class="id" type="var">fold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>.<br/>
&nbsp;<span class="id" type="var">Exists</span> <span class="id" type="var">z</span>. <span class="id" type="var">cancel</span>.<br/>
&nbsp;* <span class="comment">(*&nbsp;After&nbsp;the&nbsp;loop&nbsp;*)</span><br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">u<sub>0</sub></span>.<br/>
<span class="id" type="var">assert_PROP</span> (<span class="id" type="var">r'</span>=<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a>) <span class="id" type="tactic">by</span> (<span class="id" type="var">entailer</span>!; <span class="id" type="tactic">intuition</span>).<br/>
<span class="id" type="tactic">subst</span> <span class="id" type="var">r'</span>.<br/>
<span class="id" type="tactic">rewrite</span> <a class="idref" href="Verif_append.html#lseg_nullval"><span class="id" type="lemma">lseg_nullval</span></a>.<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#app_nil_end"><span class="id" type="lemma">app_nil_end</span></a> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">rename</span> <span class="id" type="var">s'</span> <span class="id" type="var">into</span> <span class="id" type="var">s</span>.<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 1 2.<br/>
<span class="id" type="var">Intros</span> <span class="id" type="var">p</span>. <span class="id" type="tactic">subst</span> <span class="id" type="var">p</span>.<br/>
<span class="id" type="var">forward</span>.<br/>
<span class="id" type="var">forward</span>.<br/>
<span class="id" type="var">Exists</span> <span class="id" type="var">x</span>.<br/>
<span class="id" type="var">entailer</span>!.<br/>
<span class="id" type="var">change</span> (<span class="id" type="var">h</span> :: <span class="id" type="var">r</span> ++ <span class="id" type="var">s<sub>2</sub></span>) <span class="id" type="keyword">with</span> (([<span class="id" type="var">h</span>]++<span class="id" type="var">r</span>)++<span class="id" type="var">s<sub>2</sub></span>).<br/>
<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">rewrite</span> <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass"><span class="id" type="abbreviation">app_ass</span></a>.<br/>
<span class="id" type="tactic">clear</span>.<br/>
<span class="id" type="tactic">assert</span> (<span class="id" type="definition">data_at</span> <span class="id" type="definition">Tsh</span> <a class="idref" href="Verif_append.html#t_list"><span class="id" type="definition">t_list</span></a> (<span class="id" type="var">i</span>, <span class="id" type="var">y</span>) <span class="id" type="var">t</span> * <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="var">s<sub>2</sub></span> <span class="id" type="var">y</span> |--<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<span class="id" type="var">i</span>::<span class="id" type="var">s<sub>2</sub></span>) <span class="id" type="var">t</span>).<br/>
&nbsp;<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> <span class="id" type="tactic">at</span> 2; <span class="id" type="var">fold</span> <a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a>; <span class="id" type="var">Exists</span> <span class="id" type="var">y</span>; <span class="id" type="var">cancel</span>. <span class="id" type="var">sep_apply</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="tactic">simpl</span>.<br/>
<span class="id" type="tactic">unfold</span> <a class="idref" href="Verif_append.html#lseg"><span class="id" type="definition">lseg</span></a>. <span class="id" type="var">allp_left</span> (<span class="id" type="var">i</span>::<span class="id" type="var">s<sub>2</sub></span>).<br/>
<span class="id" type="var">sep_apply</span> (<span class="id" type="lemma">modus_ponens_wand</span> (<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<span class="id" type="var">i</span>::<span class="id" type="var">s<sub>2</sub></span>) <span class="id" type="var">t</span>) (<a class="idref" href="Verif_append.html#listrep"><span class="id" type="definition">listrep</span></a> (<span class="id" type="var">s</span>++<span class="id" type="var">i</span>::<span class="id" type="var">s<sub>2</sub></span>) <span class="id" type="var">x</span>)).<br/>
<span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>
</div>



</div>

</body>
</html>